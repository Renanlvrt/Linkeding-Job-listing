import json
import sys
import numpy as np
# In production: from sentence_transformers import SentenceTransformer

"""
LAYER 3: LOCAL RANKING
Uses embeddings to semantically match a list of jobs against a user profile.
Privacy-First: Logic happens locally, not via API.

Usage: python3 rank_jobs.py <path_to_jobs.json> <path_to_user_profile.md>
"""

def mock_get_embeddings(text):
    # In production, this would use model.encode(text)
    # Here we return a random vector for structural demonstration
    return np.random.rand(384)

def cosine_similarity(v1, v2):
    return np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))

def rank_jobs(jobs_path, profile_path):
    print("ðŸ§  Loading Semantic Model (all-MiniLM-L6-v2)...")
    # model = SentenceTransformer('all-MiniLM-L6-v2') 
    
    # Load Data
    with open(jobs_path, 'r') as f:
        jobs = json.load(f)
        
    with open(profile_path, 'r') as f:
        profile_text = f.read()
        
    profile_embedding = mock_get_embeddings(profile_text)
    
    scored_jobs = []
    
    print(f"ðŸ” Ranking {len(jobs)} jobs...")
    
    for job in jobs:
        # Combine title and description for embedding
        job_text = f"{job.get('title', '')} {job.get('description', '')}"
        job_embedding = mock_get_embeddings(job_text)
        
        score = cosine_similarity(profile_embedding, job_embedding)
        
        # Soft Filtering Logic
        if score > 0.4: # Threshold
            job['match_score'] = float(score)
            scored_jobs.append(job)
            
    # Sort by highest match
    scored_jobs.sort(key=lambda x: x['match_score'], reverse=True)
    
    # Save Output
    output_path = ".tmp/ranked_jobs.json"
    with open(output_path, 'w') as f:
        json.dump(scored_jobs, f, indent=2)
        
    print(f"âœ… Ranking complete. {len(scored_jobs)} jobs qualified.")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python rank_jobs.py <jobs_json> <profile_md>")
        sys.exit(1)
        
    rank_jobs(sys.argv[1], sys.argv[2])